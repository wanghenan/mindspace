# MindSpace AI 对话功能配置指南

## 功能概述

MindSpace v1.0 现已集成阿里千问AI，实现深度共情对话功能，支持：

- **实时AI对话**：基于CBT心理学的智能共情对话
- **危机识别**：自动检测危机关键词并提供相应支持
- **情绪分析**：智能分析用户情绪并提取情绪标签
- **对话历史**：自动保存和管理对话记录
- **离线备用**：API不可用时使用本地备用逻辑

## 快速开始

### 1. 获取阿里云API密钥

1. 访问 [阿里云百炼平台](https://bailian.console.aliyun.com/)
2. 注册/登录账号
3. 进入"API-KEY管理"页面
4. 创建新的API-KEY
5. 复制API密钥（格式：`sk-xxxxxxxxxxxxx`）

### 2. 配置环境变量

在项目根目录创建 `.env` 文件：

```bash
# 复制示例配置文件
cp .env.example .env
```

编辑 `.env` 文件，填入你的API密钥：

```env
VITE_DASHSCOPE_API_KEY=sk-你的API密钥
```

### 3. 启动应用

```bash
# 安装依赖（如果还没安装）
npm install

# 启动开发服务器
npm run dev
```

应用会自动加载 `.env` 配置并连接到阿里千问API。

## 功能特性

### 🧠 智能对话系统

- **三阶段对话逻辑**：接住情绪 → 轻度探索 → 微行动/重塑
- **危机识别系统**：自动检测恐慌和自伤倾向
- **情绪标签提取**：智能分析对话中的情绪关键词
- **上下文记忆**：保留最近10条对话历史的上下文

### 🛡️ 安全机制

- **危机干预**：检测到危机关键词时提供专业回复和求助热线
- **隐私保护**：所有对话数据存储在本地浏览器
- **降级策略**：API失败时自动切换到本地备用逻辑

### 💾 对话管理

- **自动保存**：每次对话自动保存到本地存储
- **历史记录**：可查看、导出、删除历史对话
- **情绪统计**：分析对话中的情绪模式

## API费用说明

阿里千问API采用按量计费：

- **qwen-turbo模型**：¥0.008/千tokens
- **预计成本**：每次对话约0.01-0.05元
- **免费额度**：新用户通常有免费试用额度

建议监控API使用量，避免意外产生高额费用。

## 本地开发

### 离线模式

如果没有配置API密钥或API不可用，应用会自动使用本地备用逻辑：

- 基于规则的情绪识别和回复
- 预设的共情话术库
- 基本的危机检测和响应

### 调试模式

在浏览器控制台中可以查看：

```javascript
// 查看当前对话状态
localStorage.getItem('mindspace-chat-storage')

// 查看API调用日志
console.log('AI Service Debug:', window.__AI_DEBUG__)
```

## 常见问题

### Q: AI回复很慢？
A: 检查网络连接和API密钥是否正确。首次调用可能需要2-5秒。

### Q: 显示API错误？
A: 请确认：
1. API密钥格式正确（以`sk-`开头）
2. 账户有足够余额
3. 网络连接正常

### Q: 对话历史丢失？
A: 对话历史存储在浏览器localStorage中，清除浏览器数据会丢失。建议定期导出重要对话。

### Q: 如何提高AI回复质量？
A: 可以通过调整系统提示词来优化回复质量，编辑 `src/services/enhancedChatService.ts` 中的 `MINDSPACE_SYSTEM_PROMPT`。

## 技术架构

```
用户输入 → 危机检测 → 情绪分析 → API调用 → 回复生成 → 保存历史
    ↓           ↓          ↓          ↓          ↓          ↓
  本地验证    关键词匹配   标签提取   千问API   内容过滤   localStorage
```

## 隐私说明

- 所有对话数据仅存储在用户本地浏览器
- 不会上传到任何第三方服务器（除了AI API调用）
- 用户可以随时清除本地数据
- AI API调用不会存储个人身份信息

## 后续优化方向

- [ ] 支持流式响应（打字机效果）
- [ ] 多模型切换（千问/GPT等）
- [ ] 情绪周报自动生成
- [ ] 对话数据云端同步（可选）
- [ ] 语音输入支持

---

如有问题，请查看项目文档或提交Issue。